{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user profile within the ConnectVerse application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "username": {
          "type": "string",
          "description": "The user's display name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "photoURL": {
          "type": "string",
          "description": "URL to the user's profile picture or avatar.",
          "format": "uri"
        },
        "bio": {
          "type": "string",
          "description": "A short biographical description provided by the user."
        },
        "statusMessage": {
          "type": "string",
          "description": "A custom status message set by the user."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user account was created.",
          "format": "date-time"
        },
        "onlineStatus": {
          "type": "string",
          "description": "Current online presence status of the user (e.g., 'online', 'idle', 'offline')."
        },
        "lastSeen": {
          "type": "string",
          "description": "Timestamp when the user was last active or seen online.",
          "format": "date-time"
        },
        "friendIds": {
          "type": "array",
          "description": "An array of User IDs that this user has added as a friend. (Relationship: User N:N User)",
          "items": {
            "type": "string"
          }
        },
        "blockedUserIds": {
          "type": "array",
          "description": "An array of User IDs that this user has blocked. (Relationship: User N:N User)",
          "items": {
            "type": "string"
          }
        },
        "notificationPreferences": {
          "type": "array",
          "description": "An array of strings representing notification preferences (e.g., 'pushNotificationsEnabled', 'mentionAlertsEnabled')."
        },
        "profileVisibility": {
          "type": "string",
          "description": "Determines who can view this user's profile (e.g., 'public', 'friends-only', 'private')."
        }
      },
      "required": [
        "id",
        "username",
        "email",
        "createdAt",
        "onlineStatus"
      ]
    },
    "Server": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Server",
      "type": "object",
      "description": "Represents a community or server where users can join channels and communicate.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Server entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the server."
        },
        "icon": {
          "type": "string",
          "description": "URL to the server's icon image.",
          "format": "uri"
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to the User who owns this server. (Relationship: User 1:N Server)"
        },
        "isPrivate": {
          "type": "boolean",
          "description": "Indicates if the server is private and requires an invite or approval to join."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the server was created.",
          "format": "date-time"
        },
        "description": {
          "type": "string",
          "description": "A description of the server's purpose or theme."
        }
      },
      "required": [
        "id",
        "name",
        "ownerId",
        "createdAt"
      ]
    },
    "ServerMembership": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ServerMembership",
      "type": "object",
      "description": "Represents a user's membership within a specific server, including their roles.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ServerMembership entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who is a member of the server. (Relationship: User 1:N ServerMembership)"
        },
        "serverId": {
          "type": "string",
          "description": "Reference to the Server this membership belongs to. (Relationship: Server 1:N ServerMembership)"
        },
        "roles": {
          "type": "array",
          "description": "An array of strings defining the user's roles within the server (e.g., 'admin', 'moderator', 'member').",
          "items": {
            "type": "string"
          }
        },
        "joinedAt": {
          "type": "string",
          "description": "Timestamp when the user joined the server.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "serverId",
        "roles",
        "joinedAt"
      ]
    },
    "Channel": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Channel",
      "type": "object",
      "description": "Represents a communication channel within a server for text or voice chat.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Channel entity."
        },
        "serverId": {
          "type": "string",
          "description": "Reference to the Server this channel belongs to. (Relationship: Server 1:N Channel)"
        },
        "name": {
          "type": "string",
          "description": "The name of the channel."
        },
        "type": {
          "type": "string",
          "description": "The type of channel (e.g., 'text' for chat, 'voice' for audio/video calls)."
        },
        "topic": {
          "type": "string",
          "description": "A brief topic or description for the channel."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the channel was created.",
          "format": "date-time"
        },
        "membersAllowlistIds": {
          "type": "array",
          "description": "An optional array of User IDs explicitly allowed to access this channel (for private channels). (Relationship: User N:N Channel)",
          "items": {
            "type": "string"
          }
        },
        "membersDenylistIds": {
          "type": "array",
          "description": "An optional array of User IDs explicitly denied access to this channel (for banning users from a specific channel). (Relationship: User N:N Channel)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "serverId",
        "name",
        "type",
        "createdAt"
      ]
    },
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a single message sent within a channel.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Message entity."
        },
        "channelId": {
          "type": "string",
          "description": "Reference to the Channel where this message was sent. (Relationship: Channel 1:N Message)"
        },
        "senderId": {
          "type": "string",
          "description": "Reference to the User who sent this message. (Relationship: User 1:N Message)"
        },
        "text": {
          "type": "string",
          "description": "The content of the message, which may include rich text formatting."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the message was originally sent.",
          "format": "date-time"
        },
        "editedAt": {
          "type": "string",
          "description": "Timestamp when the message was last edited. Null if not edited.",
          "format": "date-time"
        },
        "isDeleted": {
          "type": "boolean",
          "description": "Flag indicating if the message has been soft-deleted."
        },
        "replyToMessageId": {
          "type": "string",
          "description": "Optional reference to the Message ID that this message is a reply to. (Relationship: Message 1:N Message)"
        },
        "quotedMessageId": {
          "type": "string",
          "description": "Optional reference to the Message ID that this message quotes. (Relationship: Message 1:N Message)"
        },
        "reactions": {
          "type": "array",
          "description": "An array of objects, each representing a reaction to the message. (Relationship: User N:N Message via Reaction)",
          "items": {
            "type": "string"
          }
        },
        "seenBy": {
          "type": "array",
          "description": "An array of User IDs who have read this message (read receipts). (Relationship: User N:N Message)",
          "items": {
            "type": "string"
          }
        },
        "attachmentIds": {
          "type": "array",
          "description": "An array of MediaAttachment IDs linked to this message. (Relationship: Message 1:N MediaAttachment)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "channelId",
        "senderId",
        "text",
        "createdAt",
        "isDeleted"
      ]
    },
    "MediaAttachment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MediaAttachment",
      "type": "object",
      "description": "Represents a file or media attached to a message.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MediaAttachment entity."
        },
        "messageId": {
          "type": "string",
          "description": "Reference to the Message this attachment belongs to. (Relationship: Message 1:N MediaAttachment)"
        },
        "uploaderId": {
          "type": "string",
          "description": "Reference to the User who uploaded this attachment. (Relationship: User 1:N MediaAttachment)"
        },
        "fileUrl": {
          "type": "string",
          "description": "URL where the media file is stored.",
          "format": "uri"
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "Optional URL for a preview thumbnail of the media.",
          "format": "uri"
        },
        "fileName": {
          "type": "string",
          "description": "The original name of the uploaded file."
        },
        "fileType": {
          "type": "string",
          "description": "The general type of the file (e.g., 'image', 'video', 'audio', 'document', 'gif')."
        },
        "fileSize": {
          "type": "number",
          "description": "The size of the file in bytes."
        },
        "uploadedAt": {
          "type": "string",
          "description": "Timestamp when the file was uploaded.",
          "format": "date-time"
        },
        "mimeType": {
          "type": "string",
          "description": "The MIME type of the file (e.g., 'image/jpeg', 'video/mp4')."
        }
      },
      "required": [
        "id",
        "messageId",
        "uploaderId",
        "fileUrl",
        "fileName",
        "fileType",
        "fileSize",
        "uploadedAt"
      ]
    },
    "Call": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Call",
      "type": "object",
      "description": "Represents a voice or video call event, either 1-to-1 or group, including voice channels.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Call entity."
        },
        "initiatorId": {
          "type": "string",
          "description": "Reference to the User who initiated the call. (Relationship: User 1:N Call)"
        },
        "channelId": {
          "type": "string",
          "description": "Optional reference to the Channel if the call is within a voice channel. (Relationship: Channel 1:N Call)"
        },
        "participantIds": {
          "type": "array",
          "description": "An array of User IDs who participated in the call. (Relationship: User N:N Call)",
          "items": {
            "type": "string"
          }
        },
        "type": {
          "type": "string",
          "description": "The type of call (e.g., 'voice', 'video')."
        },
        "startTime": {
          "type": "string",
          "description": "Timestamp when the call started.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "Timestamp when the call ended. Null if the call is ongoing.",
          "format": "date-time"
        },
        "isRecorded": {
          "type": "boolean",
          "description": "Indicates if the call was recorded."
        },
        "recordingUrl": {
          "type": "string",
          "description": "URL to the recording of the call, if 'isRecorded' is true.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "initiatorId",
        "type",
        "startTime",
        "isRecorded"
      ]
    },
    "Story": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Story",
      "type": "object",
      "description": "Represents a temporary status update or story posted by a user, typically disappearing after 24 hours.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Story entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who posted this story. (Relationship: User 1:N Story)"
        },
        "mediaUrl": {
          "type": "string",
          "description": "URL to the media content (image or video) of the story.",
          "format": "uri"
        },
        "caption": {
          "type": "string",
          "description": "Optional text caption for the story."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the story was created.",
          "format": "date-time"
        },
        "expiresAt": {
          "type": "string",
          "description": "Timestamp when the story is set to expire and disappear.",
          "format": "date-time"
        },
        "seenBy": {
          "type": "array",
          "description": "An array of User IDs who have viewed this story. (Relationship: User N:N Story)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "userId",
        "mediaUrl",
        "createdAt",
        "expiresAt"
      ]
    },
    "Invite": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Invite",
      "type": "object",
      "description": "Represents an invitation link to a server or channel, potentially with expiration and usage limits.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Invite entity."
        },
        "code": {
          "type": "string",
          "description": "The unique, human-readable code for the invite link."
        },
        "serverId": {
          "type": "string",
          "description": "Reference to the Server this invite grants access to. (Relationship: Server 1:N Invite)"
        },
        "channelId": {
          "type": "string",
          "description": "Optional reference to a specific Channel within the server this invite grants access to. (Relationship: Channel 1:N Invite)"
        },
        "createdByUserId": {
          "type": "string",
          "description": "Reference to the User who created this invite. (Relationship: User 1:N Invite)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the invite was created.",
          "format": "date-time"
        },
        "expiresAt": {
          "type": "string",
          "description": "Optional timestamp when this invite link will expire.",
          "format": "date-time"
        },
        "maxUses": {
          "type": "number",
          "description": "Optional maximum number of times this invite can be used."
        },
        "currentUses": {
          "type": "number",
          "description": "The current number of times this invite has been used."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the invite is currently active and usable."
        }
      },
      "required": [
        "id",
        "code",
        "serverId",
        "createdByUserId",
        "createdAt",
        "isActive",
        "currentUses"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores individual user profiles. Access is typically restricted to the owning user or their friends based on profile settings. Includes `friendIds` and `serverIds` for display and lookup purposes.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user, matching `request.auth.uid`."
            }
          ]
        }
      },
      {
        "path": "/servers/{serverId}",
        "definition": {
          "entityName": "Server",
          "schema": {
            "$ref": "#/backend/entities/Server"
          },
          "description": "Top-level server data. Includes `ownerId` and a denormalized `members` map (`{ [userId: string]: string[] }`) containing user IDs and their roles for direct, authorization-independent membership checks. Updates to server memberships via the `memberships` subcollection will trigger Cloud Functions to update this map.",
          "params": [
            {
              "name": "serverId",
              "description": "The unique ID of the server."
            }
          ]
        }
      },
      {
        "path": "/servers/{serverId}/memberships/{userId}",
        "definition": {
          "entityName": "ServerMembership",
          "schema": {
            "$ref": "#/backend/entities/ServerMembership"
          },
          "description": "Detailed membership records for users within a specific server. This is the source of truth for individual member roles and joined status. Changes here will trigger Cloud Functions to update the denormalized `servers/{serverId}.members` map.",
          "params": [
            {
              "name": "serverId",
              "description": "The unique ID of the parent server."
            },
            {
              "name": "userId",
              "description": "The unique ID of the member user."
            }
          ]
        }
      },
      {
        "path": "/channels/{channelId}",
        "definition": {
          "entityName": "Channel",
          "schema": {
            "$ref": "#/backend/entities/Channel"
          },
          "description": "Top-level channel data. Includes denormalized `serverId`, `serverOwnerId`, and `serverMembers` map from its parent server for authorization independence. Access is granted if `request.auth.uid` is present in `resource.data.serverMembers`.",
          "params": [
            {
              "name": "channelId",
              "description": "The unique ID of the channel."
            }
          ]
        }
      },
      {
        "path": "/channels/{channelId}/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Messages within a specific channel. Includes denormalized `serverId`, `serverOwnerId`, and `serverMembers` map (inherited from the channel's server) for full authorization independence. Message `reactions` are stored as a map `{ [emoji: string]: string[] }` (emoji to an array of user IDs).",
          "params": [
            {
              "name": "channelId",
              "description": "The unique ID of the parent channel."
            },
            {
              "name": "messageId",
              "description": "The unique ID of the message."
            }
          ]
        }
      },
      {
        "path": "/invites/{inviteCode}",
        "definition": {
          "entityName": "Invite",
          "schema": {
            "$ref": "#/backend/entities/Invite"
          },
          "description": "Server or channel invitation links, identified by a unique code. Includes `serverId` and `createdByUserId` for authorization checks.",
          "params": [
            {
              "name": "inviteCode",
              "description": "The unique code of the invite link."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/stories/{storyId}",
        "definition": {
          "entityName": "Story",
          "schema": {
            "$ref": "#/backend/entities/Story"
          },
          "description": "Temporary status updates or stories posted by a user. Ownership is defined by the `userId` in the path, ensuring simple ownership-based security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user who posted the story."
            },
            {
              "name": "storyId",
              "description": "The unique ID of the story."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure for ConnectVerse prioritizes Authorization Independence, Structural Segregation, and consistent Access Modeling to ensure a secure, scalable, and easily debuggable real-time application. The core principle of avoiding hierarchical authorization dependencies (`get()`) in security rules is achieved through strategic denormalization.\n\n**Authorization Independence via Denormalization:**\nTo enable robust security rules without costly and insecure `get()` calls, authorization context is denormalized directly into documents where access needs to be controlled. \n1.  **Servers (`servers/{serverId}`):** Each `Server` document will include a `members` map (`{ [userId: string]: string[] }`) that stores the roles of all members within that server. This allows for direct checks like `request.auth.uid in resource.data.members` for read/write access to the server itself, enabling secure `list` operations (QAPs) on the `servers` collection for members.\n2.  **Channels (`channels/{channelId}`):** To ensure channels are accessible only to members of their respective server, each `Channel` document will denormalize the `serverId`, `serverOwnerId`, and the `serverMembers` map from its parent `Server`. This means a rule checking access to a channel can directly inspect `resource.data.serverMembers` without needing to `get()` the parent server document.\n3.  **Messages (`channels/{channelId}/messages/{messageId}`):** Following the same logic, each `Message` document will denormalize `serverId`, `serverOwnerId`, and the `serverMembers` map from its parent `Channel` (which in turn received it from the `Server`). This makes message access rules completely independent, allowing direct authorization checks on the message document itself. This fully supports QAPs, as a user's membership can be verified directly on the queried `message` documents.\n\nThis denormalization strategy is critical for atomic operations (transactions/batches) and simplifies security rule logic significantly by making the authorization intent explicit within each document.\n\n**Structural Segregation & Access Modeling:**\n*   **Users (`users/{userId}`):** User profiles are stored as top-level documents, with access primarily based on `request.auth.uid == userId`. This path structure naturally secures private user data. The `friendIds` and `serverIds` arrays on the User document are primarily for client-side listing/display, while `Server.members` is the authoritative source for server authorization. User-specific ephemeral content like Stories will be a subcollection: `users/{userId}/stories/{storyId}`.\n*   **Server Memberships (`servers/{serverId}/memberships/{userId}`):** A dedicated subcollection for `ServerMembership` provides granular detail about a user's role and `joinedAt` timestamp within a specific server. This collection serves as the source of truth for the denormalized `servers/{serverId}.members` map, which would be maintained via Cloud Functions to ensure consistency.\n*   **Invites (`invites/{inviteCode}`):** A top-level collection for `Invite` links allows for easy lookup and management of server/channel invitations.\n\n**Specific Data Field Adjustments and Clarifications:**\n*   **`messages/{channelId}/chatMessages/{messageId}`:** The path has been standardized to `channels/{channelId}/messages/{messageId}` for consistency with the `Message` entity and standard subcollection naming conventions.\n*   **`Message.reactions`:** While the provided schema specified an array of strings for reactions, a more functional and common approach for real-time chat is a map `reactions: { [emoji: string]: string[] }` (emoji to an array of user IDs who reacted with that emoji). This is the recommended implementation to allow tracking who reacted with what and will be reflected in the schema description for the `firestorePaths`.\n*   **Cloud Functions for Consistency:** Maintaining the denormalized `serverMembers` maps across `servers`, `channels`, and `messages` will require Cloud Functions to trigger on changes to `servers/{serverId}/memberships/{userId}` documents. These functions would propagate updates to the respective parent `Server` document, and then cascade those changes to `Channel` and `Message` documents, ensuring data consistency while preserving authorization independence."
  }
}